# Deployment Guide

## 1. Install and run locally

### Prerequisites
- Docker Desktop (or Docker Engine + Compose plugin)
- Python 3.11+ (optional, for non-Docker local run)
- Git

### A) Run with Docker Compose (recommended)
1. Open terminal in project root:
   ```bash
   cd k8s-learning-project
   ```
2. Build and start all services:
   ```bash
   docker compose up --build -d
   ```
3. Check containers:
   ```bash
   docker compose ps
   ```
4. Access apps:
   - Frontend: `http://localhost:8080`
   - Backend API docs: `http://localhost:8000/api/docs`
   - Metrics: `http://localhost:8000/metrics`
5. Stop:
   ```bash
   docker compose down
   ```

### B) Run backend locally without Docker (optional)
1. Start PostgreSQL and Redis locally.
2. In backend folder:
   ```bash
   cd backend
   python -m venv .venv
   source .venv/bin/activate   # Linux/macOS
   # .venv\Scripts\activate    # Windows PowerShell
   pip install -r requirements.txt
   ```
3. Set env vars from `.env.example` (or create `.env`).
4. Run migrations + seed:
   ```bash
   ../scripts/migrate.sh
   ../scripts/init_db.sh
   ```
5. Start API:
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
   ```
6. In another terminal, start worker:
   ```bash
   celery -A app.workers.celery_app.celery_app worker --loglevel=info
   ```

---

## 2. Cloud installation on GKE / EKS

### Common prerequisites
- A container registry (GHCR, ECR, GCR/Artifact Registry)
- `kubectl` installed and configured
- Docker build access
- Update image names in:
  - `k8s/backend/deployment.yaml`
  - `k8s/backend/worker-deployment.yaml`
  - `k8s/frontend/deployment.yaml`

### Build and push images (common)
From project root:
```bash
docker build -t <REGISTRY>/k8s-learning-backend:<TAG> ./backend
docker build -t <REGISTRY>/k8s-learning-frontend:<TAG> ./frontend
docker push <REGISTRY>/k8s-learning-backend:<TAG>
docker push <REGISTRY>/k8s-learning-frontend:<TAG>
```

Then set deployments to the pushed tags:
```bash
kubectl -n k8s-learning set image deployment/backend-api backend=<REGISTRY>/k8s-learning-backend:<TAG>
kubectl -n k8s-learning set image deployment/backend-worker worker=<REGISTRY>/k8s-learning-backend:<TAG>
kubectl -n k8s-learning set image deployment/frontend-web frontend=<REGISTRY>/k8s-learning-frontend:<TAG>
```

---

### A) Deploy on GKE (Google Kubernetes Engine)

1. Install Google Cloud CLI and authenticate:
   ```bash
   gcloud auth login
   gcloud config set project <GCP_PROJECT_ID>
   ```
2. Create cluster:
   ```bash
   gcloud container clusters create k8s-learning-cluster \
     --region us-central1 \
     --num-nodes 3
   ```
3. Get cluster credentials:
   ```bash
   gcloud container clusters get-credentials k8s-learning-cluster --region us-central1
   ```
4. (Recommended) Install NGINX Ingress Controller:
   ```bash
   kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
   ```
5. Apply manifests:
   ```bash
   kubectl apply -f k8s/namespaces/namespace.yaml
   kubectl apply -f k8s/rbac/backend-rbac.yaml
   kubectl apply -f k8s/backend/configmap.yaml
   kubectl apply -f k8s/backend/secret.yaml
   kubectl apply -f k8s/postgres/pvc.yaml
   kubectl apply -f k8s/postgres/service.yaml
   kubectl apply -f k8s/postgres/statefulset.yaml
   kubectl apply -f k8s/redis/service.yaml
   kubectl apply -f k8s/redis/deployment.yaml
   kubectl apply -f k8s/backend/deployment.yaml
   kubectl apply -f k8s/backend/worker-deployment.yaml
   kubectl apply -f k8s/backend/service.yaml
   kubectl apply -f k8s/backend/hpa.yaml
   kubectl apply -f k8s/frontend/deployment.yaml
   kubectl apply -f k8s/frontend/service.yaml
   kubectl apply -f k8s/monitoring/prometheus.yaml
   kubectl apply -f k8s/monitoring/grafana.yaml
   kubectl apply -f k8s/ingress/ingress.yaml
   ```
6. Verify:
   ```bash
   kubectl get pods -n k8s-learning
   kubectl get svc -n k8s-learning
   kubectl get ingress -n k8s-learning
   ```

---

### B) Deploy on EKS (Amazon Elastic Kubernetes Service)

1. Install `awscli`, `eksctl`, `kubectl`, then authenticate AWS:
   ```bash
   aws configure
   ```
2. Create cluster:
   ```bash
   eksctl create cluster \
     --name k8s-learning-cluster \
     --region us-east-1 \
     --nodes 3
   ```
3. Update kubeconfig:
   ```bash
   aws eks update-kubeconfig --name k8s-learning-cluster --region us-east-1
   ```
4. Install NGINX Ingress Controller:
   ```bash
   kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
   ```
5. Apply manifests:
   ```bash
   kubectl apply -f k8s/namespaces/namespace.yaml
   kubectl apply -f k8s/rbac/backend-rbac.yaml
   kubectl apply -f k8s/backend/configmap.yaml
   kubectl apply -f k8s/backend/secret.yaml
   kubectl apply -f k8s/postgres/pvc.yaml
   kubectl apply -f k8s/postgres/service.yaml
   kubectl apply -f k8s/postgres/statefulset.yaml
   kubectl apply -f k8s/redis/service.yaml
   kubectl apply -f k8s/redis/deployment.yaml
   kubectl apply -f k8s/backend/deployment.yaml
   kubectl apply -f k8s/backend/worker-deployment.yaml
   kubectl apply -f k8s/backend/service.yaml
   kubectl apply -f k8s/backend/hpa.yaml
   kubectl apply -f k8s/frontend/deployment.yaml
   kubectl apply -f k8s/frontend/service.yaml
   kubectl apply -f k8s/monitoring/prometheus.yaml
   kubectl apply -f k8s/monitoring/grafana.yaml
   kubectl apply -f k8s/ingress/ingress.yaml
   ```
6. Verify:
   ```bash
   kubectl get pods -n k8s-learning
   kubectl get svc -n k8s-learning
   kubectl get ingress -n k8s-learning
   ```

---

## Quick health checks

```bash
kubectl get hpa -n k8s-learning
kubectl logs deployment/backend-api -n k8s-learning --tail=200
kubectl logs deployment/backend-worker -n k8s-learning --tail=200
```
